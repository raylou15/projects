#!/usr/bin/env bash
set -euo pipefail

# =========================
# DEPLOY FROM GITHUB REPO
# Run on the SERVER
# =========================

# -------- CONFIG (edit once) --------
# Where the GitHub repo is CLONED on the server:
REPO_DIR="${REPO_DIR:-/root/repo}"     # <-- change if your repo lives elsewhere
BRANCH="${BRANCH:-main}"

# Process / domain
APP_NAME="${APP_NAME:-rays-games}"
DOMAIN="${DOMAIN:-https://rays-games.loseyourip.com}"

# Destinations (per your mapping)
DEST_CADDY="/etc/caddy"
DEST_CMDS="/usr/local/bin"
DEST_CONTEXT="/root/projects/context-clues"
DEST_RAYSGAMES="/root/rays-games"
WEB_ROOT="/var/www/rays-games"

# Source folders INSIDE the repo
SRC_CADDY="$REPO_DIR/deploy/caddy"
SRC_CMDS="$REPO_DIR/deploy/cmds"
SRC_CONTEXT="$REPO_DIR/context-clues"
SRC_RAYSGAMES="$REPO_DIR/rays-games"

# Runtime locations (what actually runs/builds)
BACKEND_DIR="$DEST_RAYSGAMES/server"          # PM2 backend lives here
FRONTEND_DIR="$DEST_CONTEXT/client"          # Vite frontend lives here (build -> WEB_ROOT)

# -------- helpers --------
SUDO=""
if [ "$(id -u)" -ne 0 ]; then SUDO="sudo"; fi

log() { echo -e "\n==> $*"; }

need_dir() {
  if [ ! -d "$1" ]; then
    echo "ERROR: Missing directory: $1"
    exit 1
  fi
}

npm_install() {
  # Use npm ci if package-lock exists, else npm install
  if [ -f package-lock.json ]; then
    npm ci
  else
    npm install
  fi
}

# -------- sanity checks --------
need_dir "$REPO_DIR"
if ! git -C "$REPO_DIR" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "ERROR: REPO_DIR is not a git repo: $REPO_DIR"
  echo "Set REPO_DIR to the folder where you cloned your GitHub repo."
  exit 1
fi

need_dir "$SRC_CADDY"
need_dir "$SRC_CMDS"
need_dir "$SRC_CONTEXT"
need_dir "$SRC_RAYSGAMES"

log "Deploy startingâ€¦"
date

# -------- 1) Update repo to latest origin/BRANCH --------
log "Git: fetch + hard reset to origin/$BRANCH"
git -C "$REPO_DIR" fetch --all --prune
git -C "$REPO_DIR" checkout "$BRANCH"
git -C "$REPO_DIR" reset --hard "origin/$BRANCH"

log "Git: current HEAD"
git -C "$REPO_DIR" --no-pager log -1 --oneline

# -------- 2) Deploy Caddy config + command scripts --------
log "Deploy: Caddy config -> $DEST_CADDY"
$SUDO rsync -av --delete "$SRC_CADDY/" "$DEST_CADDY/"

log "Deploy: commands -> $DEST_CMDS"
$SUDO rsync -av "$SRC_CMDS/" "$DEST_CMDS/"
# Ensure scripts are executable
$SUDO find "$DEST_CMDS" -maxdepth 1 -type f -name "*.sh" -exec chmod +x {} \; || true
$SUDO find "$DEST_CMDS" -maxdepth 1 -type f -name "deploy-*" -exec chmod +x {} \; || true

# -------- 3) Deploy code to destinations (overwrite as needed) --------
log "Deploy: context-clues -> $DEST_CONTEXT"
$SUDO mkdir -p "$(dirname "$DEST_CONTEXT")"
$SUDO rsync -av --delete \
  --exclude ".git/" \
  --exclude "node_modules/" \
  --exclude "dist/" \
  --exclude ".env" \
  --exclude ".env.*" \
  "$SRC_CONTEXT/" "$DEST_CONTEXT/"

log "Deploy: rays-games -> $DEST_RAYSGAMES"
$SUDO mkdir -p "$DEST_RAYSGAMES"
$SUDO rsync -av --delete \
  --exclude ".git/" \
  --exclude "node_modules/" \
  --exclude "dist/" \
  --exclude ".env" \
  --exclude ".env.*" \
  --exclude "server/data/glove.*" \
  --exclude "server/data/embeddings.trimmed.json" \
  "$SRC_RAYSGAMES/" "$DEST_RAYSGAMES/"

# -------- 4) Backend: install deps + restart PM2 --------
need_dir "$BACKEND_DIR"
log "Backend: install deps in $BACKEND_DIR"
cd "$BACKEND_DIR"
npm_install

log "Backend: pm2 restart $APP_NAME"
pm2 restart "$APP_NAME" --update-env
pm2 save

log "Backend: health checks"
curl -fsS http://127.0.0.1:3000/health | cat; echo
curl -fsS "$DOMAIN/api/health" | cat; echo

# -------- 5) Frontend: install deps + build + publish dist --------
if [ -d "$FRONTEND_DIR" ] && [ -f "$FRONTEND_DIR/package.json" ]; then
  log "Frontend: install + build in $FRONTEND_DIR"
  cd "$FRONTEND_DIR"
  npm_install
  npm run build

  log "Frontend: publish dist -> $WEB_ROOT"
  $SUDO mkdir -p "$WEB_ROOT"
  $SUDO rsync -av --delete dist/ "$WEB_ROOT/"
else
  log "Frontend: SKIPPED (missing $FRONTEND_DIR/package.json)"
fi

# -------- 6) Caddy validate + reload --------
log "Caddy: validate + reload"
$SUDO caddy validate --config /etc/caddy/Caddyfile
$SUDO systemctl reload caddy

log "Homepage check"
curl -i "$DOMAIN/" | head -n 12

log "PM2 logs (last 30 lines)"
pm2 logs "$APP_NAME" --lines 30 --nostream || true

log "Deploy finished."
