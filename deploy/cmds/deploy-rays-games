#!/usr/bin/env bash
# =========================
# RAYS-GAMES DEPLOY (FROM GITHUB)
# Run this on the SERVER
# Repo: https://github.com/raylou15/projects.git
# =========================

set -euo pipefail

# ---------- CONFIG ----------
APP_NAME="rays-games"
GIT_URL="https://github.com/raylou15/projects.git"
BRANCH="main"

# Where the GitHub repo is cloned ON THE SERVER (do not set this to /root/projects)
CLONE_DIR="/root/github/projects"

# Destinations ON THE SERVER
DEST_CADDY="/etc/caddy"
DEST_CMDS="/usr/local/bin"
DEST_CONTEXT="/root/projects/context-clues"
DEST_RAYSGAMES="/root/rays-games"
WEB_ROOT="/var/www/rays-games"

DOMAIN="https://rays-games.loseyourip.com"

# Repo paths (inside GitHub repo)
SRC_CADDY="$CLONE_DIR/deploy/caddy"
SRC_CMDS="$CLONE_DIR/deploy/cmds"
SRC_CONTEXT="$CLONE_DIR/context-clues"
SRC_RAYSGAMES="$CLONE_DIR/rays-games"

# ---------- helpers ----------
SUDO=""
if [ "$(id -u)" -ne 0 ]; then SUDO="sudo"; fi

log() { echo -e "\n==> $*"; }

need_dir() {
  if [ ! -d "$1" ]; then
    echo "ERROR: Missing directory: $1"
    exit 1
  fi
}

npm_install() {
  # Prefer reproducible installs when lockfile exists
  if [ -f package-lock.json ]; then
    npm ci
  else
    npm install
  fi
}

# ---------- start ----------
log "Deploy starting…"
date

log "Ensuring dependencies (git, rsync)"
$SUDO apt-get update -y >/dev/null
$SUDO apt-get install -y git rsync >/dev/null

# 1) Clone or update the GitHub repo (ON THE SERVER)
log "GitHub: sync repo into $CLONE_DIR"
if [ ! -d "$CLONE_DIR/.git" ]; then
  $SUDO mkdir -p "$(dirname "$CLONE_DIR")"
  $SUDO git clone --branch "$BRANCH" "$GIT_URL" "$CLONE_DIR"
else
  git -C "$CLONE_DIR" fetch --all --prune
  git -C "$CLONE_DIR" checkout "$BRANCH"
  git -C "$CLONE_DIR" reset --hard "origin/$BRANCH"
fi

log "GitHub: current HEAD"
git -C "$CLONE_DIR" --no-pager log -1 --oneline

# Sanity: required folders exist in repo
need_dir "$SRC_CONTEXT"
need_dir "$SRC_RAYSGAMES"

# 2) Deploy Caddy + command scripts (ON THE SERVER)
if [ -d "$SRC_CADDY" ]; then
  log "Deploy: $SRC_CADDY -> $DEST_CADDY"
  $SUDO rsync -av --delete "$SRC_CADDY/" "$DEST_CADDY/"
else
  log "Deploy: SKIP caddy (missing $SRC_CADDY)"
fi

if [ -d "$SRC_CMDS" ]; then
  log "Deploy: $SRC_CMDS -> $DEST_CMDS"
  $SUDO rsync -av "$SRC_CMDS/" "$DEST_CMDS/"
  # Make common script files executable
  $SUDO find "$DEST_CMDS" -maxdepth 1 -type f -name "*.sh" -exec chmod +x {} \; || true
  $SUDO find "$DEST_CMDS" -maxdepth 1 -type f -name "deploy-*" -exec chmod +x {} \; || true
else
  log "Deploy: SKIP cmds (missing $SRC_CMDS)"
fi

# 3) Deploy application code (overwrite as needed, BUT preserve secrets + huge embedding sources)
log "Deploy: $SRC_CONTEXT -> $DEST_CONTEXT"
$SUDO mkdir -p "$DEST_CONTEXT"
$SUDO rsync -av --delete \
  --exclude ".git/" \
  --exclude "node_modules/" \
  --exclude "dist/" \
  --exclude ".env" \
  --exclude ".env.*" \
  "$SRC_CONTEXT/" "$DEST_CONTEXT/"

log "Deploy: $SRC_RAYSGAMES -> $DEST_RAYSGAMES"
$SUDO mkdir -p "$DEST_RAYSGAMES"
$SUDO rsync -av --delete \
  --exclude ".git/" \
  --exclude "node_modules/" \
  --exclude "dist/" \
  --exclude ".env" \
  --exclude ".env.*" \
  --exclude "server/data/glove.*" \
  --exclude "server/data/embeddings.trimmed.json" \
  "$SRC_RAYSGAMES/" "$DEST_RAYSGAMES/"

# 4) Backend: detect correct backend folder and install deps (ON THE SERVER)
BACKEND_DIR=""
if [ -f "$DEST_RAYSGAMES/server/package.json" ]; then
  BACKEND_DIR="$DEST_RAYSGAMES/server"
elif [ -f "$DEST_RAYSGAMES/package.json" ]; then
  BACKEND_DIR="$DEST_RAYSGAMES"
else
  echo "ERROR: Can't find backend package.json in $DEST_RAYSGAMES or $DEST_RAYSGAMES/server"
  exit 1
fi

log "Backend: npm install in $BACKEND_DIR"
cd "$BACKEND_DIR"
npm_install

log "Backend: pm2 restart ($APP_NAME)"
pm2 restart "$APP_NAME" --update-env
pm2 save

# Add this right AFTER:
# pm2 restart "$APP_NAME" --update-env
# pm2 save

log "Backend: waiting for restart…"
sleep 3

# (Optional but better) wait up to ~30s until /health responds
log "Backend: waiting for /health to come up (max 30s)…"
for i in {1..15}; do
  if curl -fsS http://127.0.0.1:3000/health >/dev/null 2>&1; then
    echo "✅ Backend is up."
    break
  fi
  echo "…not up yet, retrying ($i/15)"
  sleep 2
done

# Now run the normal checks
log "Backend: health (local)"
curl -fsS http://127.0.0.1:3000/health | cat; echo

log "Backend: health (public)"
curl -fsS "$DOMAIN/api/health" | cat; echo


# 5) Frontend: build + publish dist (ON THE SERVER)
FRONTEND_DIR="$DEST_CONTEXT/client"
if [ ! -f "$FRONTEND_DIR/package.json" ]; then
  echo "ERROR: Can't find frontend at $FRONTEND_DIR/package.json"
  exit 1
fi

log "Frontend: npm install + build in $FRONTEND_DIR"
cd "$FRONTEND_DIR"
npm_install
npm run build

log "Frontend: publish dist -> $WEB_ROOT"
$SUDO mkdir -p "$WEB_ROOT"
$SUDO rsync -av --delete dist/ "$WEB_ROOT/"

# 6) Caddy validate + reload (ON THE SERVER)
log "Caddy: validate + reload"
$SUDO caddy validate --config /etc/caddy/Caddyfile
$SUDO systemctl reload caddy

log "Homepage check"
curl -i "$DOMAIN/" | head -n 12

log "PM2 last 30 lines"
pm2 logs "$APP_NAME" --lines 30 --nostream || true

log "Deploy finished."
